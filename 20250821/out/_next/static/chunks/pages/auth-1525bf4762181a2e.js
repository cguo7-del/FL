(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[473],{3969:function(e,s,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/auth",function(){return r(4604)}])},5981:function(e,s,r){"use strict";r.d(s,{G_:function(){return d},YX:function(){return u},r5:function(){return c},supabase:function(){return l}});var t=r(1608),a=r(3454);let n=a.env.SUPABASE_URL||"https://crnfwlpcxrnqfgwqnmun.supabase.co",i=a.env.SUPABASE_ANON_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNybmZ3bHBjeHJucWZnd3FubXVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTAzMDQsImV4cCI6MjA3MDcyNjMwNH0.g_HmFQQiuGW2TZRzZ5gqCj098DZy6iwn_xQAE6kEUEI",l=(0,t.eI)(n,i),o=e=>(null==e?void 0:e.message)?({"Invalid login credentials":"登录凭证无效，请检查邮箱和密码","Email not confirmed":"邮箱未验证，请检查您的邮箱并点击验证链接","User already registered":"该邮箱已被注册，请使用其他邮箱或直接登录","Password should be at least 6 characters":"密码至少需要6个字符","Signup requires a valid password":"注册需要有效的密码","Invalid email":"邮箱格式不正确","Email rate limit exceeded":"邮件发送频率过高，请稍后再试","Too many requests":"请求过于频繁，请稍后再试","Network request failed":"网络请求失败，请检查网络连接","User not found":"用户不存在","Email already taken":"该邮箱已被使用","Weak password":"密码强度不够，请使用更复杂的密码"})[e.message]||e.message:"发生未知错误，请稍后重试",c={async signUp(e,s,r){try{let{data:t,error:a}=await l.auth.signUp({email:e,password:s,options:{data:{username:r}}});if(a)throw Error(o(a));return t}catch(e){throw Error(o(e))}},async signIn(e,s){try{let{data:r,error:t}=await l.auth.signInWithPassword({email:e,password:s});if(t)throw Error(o(t));return r}catch(e){throw Error(o(e))}},async signOut(){try{let{error:e}=await l.auth.signOut();if(e)throw Error(o(e));return!0}catch(e){throw Error(o(e))}},async getCurrentUser(){try{let{data:{user:e},error:s}=await l.auth.getUser();if(s)throw Error(o(s));return e}catch(e){throw Error(o(e))}},onAuthStateChange:e=>l.auth.onAuthStateChange(e)},u={supabase:l,async insert(e,s){let{data:r,error:t}=await l.from(e).insert(s).select();if(t)throw console.error("插入数据错误:",t),t;return r},async select(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=l.from(e).select("*");Object.entries(s).forEach(e=>{let[s,t]=e;r=r.eq(s,t)});let{data:t,error:a}=await r;if(a)throw console.error("查询数据错误:",a),a;return t},async update(e,s,r){let{data:t,error:a}=await l.from(e).update(r).eq("id",s).select();if(a)throw console.error("更新数据错误:",a),a;return t},async delete(e,s){let{error:r}=await l.from(e).delete().eq("id",s);if(r)throw console.error("删除数据错误:",r),r;return!0},async testConnection(){try{let{data:e,error:s}=await l.rpc("version");if(s){let{error:e}=await l.from("test_connection_table").select("*").limit(1);if(e&&("PGRST116"===e.code||"42P01"===e.code))return console.log("数据库连接成功!"),!0;return console.error("数据库连接测试失败:",e||s),!1}return console.log("数据库连接成功!"),!0}catch(e){return console.error("连接测试异常:",e),!1}}},d={async saveCollection(e,s,r){try{let{data:t,error:a}=await l.from("user_collections").insert({user_id:e,question:s,answer:r}).select();if(a)throw console.error("收藏保存失败:",a),a;return t[0]}catch(e){throw console.error("收藏操作异常:",e),e}},async getUserCollections(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{let t=(s-1)*r,{data:a,error:n,count:i}=await l.from("user_collections").select("*",{count:"exact"}).eq("user_id",e).order("updated_at",{ascending:!1}).range(t,t+r-1);if(n)throw console.error("获取收藏列表失败:",n),n;return{data:a||[],total:i||0,page:s,pageSize:r,totalPages:Math.ceil((i||0)/r)}}catch(e){throw console.error("获取收藏列表异常:",e),e}},async deleteCollections(e){try{let{error:s}=await l.from("user_collections").delete().in("id",e);if(s)throw console.error("删除收藏失败:",s),s;return!0}catch(e){throw console.error("删除收藏异常:",e),e}},async checkIfCollected(e,s){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{let t=l.from("user_collections").select("id").eq("user_id",e).eq("question",s);r&&(t=t.ilike("answer","%".concat(r,"%")));let{data:a,error:n}=await t.limit(1);if(n)throw console.error("检查收藏状态失败:",n),n;return a&&a.length>0}catch(e){throw console.error("检查收藏状态异常:",e),e}}}},4604:function(e,s,r){"use strict";r.r(s),r.d(s,{default:function(){return d}});var t=r(5893),a=r(7294),n=r(1163),i=r(9008),l=r.n(i),o=r(3323),c=r.n(o),u=r(5981);function d(){let e=(0,n.useRouter)(),[s,r]=(0,a.useState)(!0),[i,o]=(0,a.useState)({email:"",username:"",password:"",confirmPassword:""}),[d,h]=(0,a.useState)({}),[m,p]=(0,a.useState)(!1),[_,w]=(0,a.useState)(""),[f,g]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{try{let s=await u.r5.getCurrentUser();g(s),s&&e.push("/")}catch(e){console.log("用户未登录")}})();let{data:{subscription:s}}=u.r5.onAuthStateChange((s,r)=>{"SIGNED_IN"===s?(g((null==r?void 0:r.user)||null),e.push("/")):"SIGNED_OUT"===s&&g(null)});return()=>s.unsubscribe()},[]);let v=()=>{let e={};if(i.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.email)||(e.email="请检查邮箱格式"):e.email="请输入邮箱地址",s)i.password||(e.password="请输入密码");else{if(i.username?i.username.length<3&&(e.username="用户名至少需要3个字符"):e.username="请输入用户名",i.password){let s=i.password,r=/\d/.test(s),t=/[a-zA-Z]/.test(s),a=/[!@#$%^&*(),.?":{}|<>]/.test(s);s.length<8?e.password="密码至少需要8位字符":r?t?a||(e.password="密码必须包含特殊符号"):e.password="密码必须包含字母":e.password="密码必须包含数字"}else e.password="请输入密码";i.confirmPassword?i.password!==i.confirmPassword&&(e.confirmPassword="两次输入的密码不一致"):e.confirmPassword="请确认密码"}return h(e),0===Object.keys(e).length},x=(e,s)=>{o(r=>({...r,[e]:s})),d[e]&&h(s=>({...s,[e]:""}))},j=async e=>{if(e.preventDefault(),v()){p(!0),w("");try{await u.r5.signUp(i.email,i.password,i.username),w("注册成功！请检查您的邮箱并点击验证链接完成注册。"),o({email:"",username:"",password:"",confirmPassword:""})}catch(e){console.error("注册错误:",e),w(e.message)}finally{p(!1)}}},N=async e=>{if(e.preventDefault(),v()){p(!0),w("");try{await u.r5.signIn(i.email,i.password),w("登录成功！正在跳转...")}catch(e){console.error("登录错误:",e),w(e.message)}finally{p(!1)}}};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(l(),{children:[(0,t.jsxs)("title",{children:[s?"登录":"注册"," - 方略 Fanglue"]}),(0,t.jsx)("meta",{name:"description",content:"方略 - 从经史到兵法，古智与算法，同答一问"}),(0,t.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,t.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,t.jsxs)("div",{className:c().container,children:[(0,t.jsx)("nav",{className:c().navbar,children:(0,t.jsx)("div",{className:c().brand,onClick:()=>e.push("/"),style:{cursor:"pointer"},children:"方略 Fanglue"})}),(0,t.jsx)("main",{className:c().mainContent,children:(0,t.jsxs)("div",{className:c().authCard,children:[(0,t.jsxs)("div",{className:c().authTabs,children:[(0,t.jsx)("button",{className:"".concat(c().tabButton," ").concat(s?c().active:""),onClick:()=>{r(!0),h({}),w("")},children:"登录"}),(0,t.jsx)("button",{className:"".concat(c().tabButton," ").concat(s?"":c().active),onClick:()=>{r(!1),h({}),w("")},children:"注册"})]}),(0,t.jsxs)("form",{onSubmit:s?N:j,className:c().authForm,children:[(0,t.jsxs)("div",{className:c().inputGroup,children:[(0,t.jsxs)("label",{className:c().label,children:["邮箱地址",(0,t.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,t.jsx)("input",{type:"email",value:i.email,onChange:e=>x("email",e.target.value),className:"".concat(c().input," ").concat(d.email?c().error:""),placeholder:"请输入您的邮箱地址",disabled:m}),d.email&&(0,t.jsx)("span",{className:c().errorText,children:d.email})]}),!s&&(0,t.jsxs)("div",{className:c().inputGroup,children:[(0,t.jsxs)("label",{className:c().label,children:["用户名",(0,t.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,t.jsx)("input",{type:"text",value:i.username,onChange:e=>x("username",e.target.value),className:"".concat(c().input," ").concat(d.username?c().error:""),placeholder:"至少3个字符",disabled:m}),(0,t.jsx)("div",{className:c().hint,children:i.username.length>0&&(0,t.jsxs)("span",{className:i.username.length>=3?c().valid:c().invalid,children:[i.username.length,"/3 字符"]})}),d.username&&(0,t.jsx)("span",{className:c().errorText,children:d.username})]}),(0,t.jsxs)("div",{className:c().inputGroup,children:[(0,t.jsxs)("label",{className:c().label,children:["密码",(0,t.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,t.jsx)("input",{type:"password",value:i.password,onChange:e=>x("password",e.target.value),className:"".concat(c().input," ").concat(d.password?c().error:""),placeholder:s?"请输入密码":"8位以上，包含数字、字母和特殊符号",disabled:m}),!s&&i.password&&(0,t.jsxs)("div",{className:c().passwordStrength,children:[(0,t.jsx)("div",{className:c().strengthItem,children:(0,t.jsx)("span",{className:i.password.length>=8?c().valid:c().invalid,children:"✓ 至少8位字符"})}),(0,t.jsx)("div",{className:c().strengthItem,children:(0,t.jsx)("span",{className:/\d/.test(i.password)?c().valid:c().invalid,children:"✓ 包含数字"})}),(0,t.jsx)("div",{className:c().strengthItem,children:(0,t.jsx)("span",{className:/[a-zA-Z]/.test(i.password)?c().valid:c().invalid,children:"✓ 包含字母"})}),(0,t.jsx)("div",{className:c().strengthItem,children:(0,t.jsx)("span",{className:/[!@#$%^&*(),.?":{}|<>]/.test(i.password)?c().valid:c().invalid,children:"✓ 包含特殊符号"})})]}),d.password&&(0,t.jsx)("span",{className:c().errorText,children:d.password})]}),!s&&(0,t.jsxs)("div",{className:c().inputGroup,children:[(0,t.jsxs)("label",{className:c().label,children:["确认密码",(0,t.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,t.jsx)("input",{type:"password",value:i.confirmPassword,onChange:e=>x("confirmPassword",e.target.value),className:"".concat(c().input," ").concat(d.confirmPassword?c().error:""),placeholder:"请再次输入密码",disabled:m}),i.confirmPassword&&(0,t.jsx)("div",{className:c().hint,children:(0,t.jsx)("span",{className:i.password===i.confirmPassword?c().valid:c().invalid,children:i.password===i.confirmPassword?"✓ 密码一致":"✗ 密码不一致"})}),d.confirmPassword&&(0,t.jsx)("span",{className:c().errorText,children:d.confirmPassword})]}),(0,t.jsx)("button",{type:"submit",className:c().submitButton,disabled:m||Object.keys(d).some(e=>d[e]),children:m?"处理中...":s?"登录":"注册"}),_&&(0,t.jsx)("div",{className:"".concat(c().message," ").concat(_.includes("成功")?c().success:c().error),children:_})]})]})})]})]})}},3323:function(e){e.exports={container:"Auth_container__0j_dd",navbar:"Auth_navbar__yb_gp",brand:"Auth_brand__VpLSG",mainContent:"Auth_mainContent__MOMp6",authCard:"Auth_authCard__c52sr",slideUp:"Auth_slideUp__qeMUA",authTabs:"Auth_authTabs__5_7HH",tabButton:"Auth_tabButton__hh0se",active:"Auth_active__HnjZM",authForm:"Auth_authForm__Q3DLf",inputGroup:"Auth_inputGroup__O2PQ9",label:"Auth_label__si14T",requiredAsterisk:"Auth_requiredAsterisk___2jh_",input:"Auth_input___yjIt",error:"Auth_error__npNR5",hint:"Auth_hint__Mc8tH",errorText:"Auth_errorText__FtdKD",valid:"Auth_valid__dI1Xr",invalid:"Auth_invalid__i8q04",passwordStrength:"Auth_passwordStrength__j_3TF",strengthItem:"Auth_strengthItem__j8RZr",submitButton:"Auth_submitButton__Pzzy8",message:"Auth_message__Xz_Ou",success:"Auth_success__qQE_4"}},9008:function(e,s,r){e.exports=r(4764)},1163:function(e,s,r){e.exports=r(2937)}},function(e){e.O(0,[608,774,888,179],function(){return e(e.s=3969)}),_N_E=e.O()}]);