(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[277],{9344:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/profile",function(){return r(9078)}])},5981:function(e,t,r){"use strict";r.d(t,{G_:function(){return u},YX:function(){return d},r5:function(){return c},supabase:function(){return i},x0:function(){return l}});var s=r(1608),a=r(3454);let o=a.env.SUPABASE_URL||"https://crnfwlpcxrnqfgwqnmun.supabase.co",n=a.env.SUPABASE_ANON_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNybmZ3bHBjeHJucWZnd3FubXVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTAzMDQsImV4cCI6MjA3MDcyNjMwNH0.g_HmFQQiuGW2TZRzZ5gqCj098DZy6iwn_xQAE6kEUEI",i=(0,s.eI)(o,n),l=e=>{let t="";return("string"==typeof e?t=e:(null==e?void 0:e.message)?t=e.message:(null==e?void 0:e.error_description)&&(t=e.error_description),t.toLowerCase().includes("new password should be different"))?"新密码不能与旧密码相同":({"Invalid login credentials":"邮箱或密码错误","Email not confirmed":"邮箱未验证，请检查您的邮箱","User already registered":"该邮箱已注册","Password should be at least 6 characters":"密码至少需要6位字符","Signup requires a valid password":"注册需要有效的密码","Invalid email":"邮箱格式不正确","Email rate limit exceeded":"邮件发送频率过高，请稍后再试","Too many requests":"请求过于频繁，请稍后再试","Network request failed":"网络请求失败，请检查网络连接","User not found":"用户不存在","Email already taken":"该邮箱已被使用","Weak password":"密码强度不够，请使用更复杂的密码","New password should be different from the old password":"新密码不能与旧密码相同","new password should be different from the old password":"新密码不能与旧密码相同","Password update failed":"密码更新失败，请稍后重试","Session not found":"会话已过期，请重新获取重置链接","Invalid recovery token":"重置链接无效或已过期，请重新申请","Auth session missing":"认证会话缺失，请重新获取重置链接"})[t]||t||"发生未知错误，请稍后重试"},c={async signUp(e,t,r){try{let{data:s,error:a}=await i.auth.signUp({email:e,password:t,options:{data:{username:r},emailRedirectTo:"".concat("https://fanglue.org","/auth")}});if(a)throw Error(l(a));return s}catch(e){throw Error(l(e))}},async signIn(e,t){try{let{data:r,error:s}=await i.auth.signInWithPassword({email:e,password:t});if(s)throw Error(l(s));return r}catch(e){throw Error(l(e))}},async signOut(){try{let{error:e}=await i.auth.signOut();if(e)throw Error(l(e));return!0}catch(e){throw Error(l(e))}},async getCurrentUser(){try{let{data:{user:e},error:t}=await i.auth.getUser();if(t)throw Error(l(t));return e}catch(e){throw Error(l(e))}},onAuthStateChange:e=>i.auth.onAuthStateChange(e)},d={supabase:i,async insert(e,t){let{data:r,error:s}=await i.from(e).insert(t).select();if(s)throw console.error("插入数据错误:",s),s;return r},async select(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=i.from(e).select("*");Object.entries(t).forEach(e=>{let[t,s]=e;r=r.eq(t,s)});let{data:s,error:a}=await r;if(a)throw console.error("查询数据错误:",a),a;return s},async update(e,t,r){let{data:s,error:a}=await i.from(e).update(r).eq("id",t).select();if(a)throw console.error("更新数据错误:",a),a;return s},async delete(e,t){let{error:r}=await i.from(e).delete().eq("id",t);if(r)throw console.error("删除数据错误:",r),r;return!0},async testConnection(){try{let{data:e,error:t}=await i.rpc("version");if(t){let{error:e}=await i.from("test_connection_table").select("*").limit(1);if(e&&("PGRST116"===e.code||"42P01"===e.code))return console.log("数据库连接成功!"),!0;return console.error("数据库连接测试失败:",e||t),!1}return console.log("数据库连接成功!"),!0}catch(e){return console.error("连接测试异常:",e),!1}}},u={async saveCollection(e,t,r){try{let{data:s,error:a}=await i.from("user_collections").insert({user_id:e,question:t,answer:r}).select();if(a)throw console.error("收藏保存失败:",a),a;return s[0]}catch(e){throw console.error("收藏操作异常:",e),e}},async getUserCollections(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{let s=(t-1)*r,{data:a,error:o,count:n}=await i.from("user_collections").select("*",{count:"exact"}).eq("user_id",e).order("updated_at",{ascending:!1}).range(s,s+r-1);if(o)throw console.error("获取收藏列表失败:",o),o;return{data:a||[],total:n||0,page:t,pageSize:r,totalPages:Math.ceil((n||0)/r)}}catch(e){throw console.error("获取收藏列表异常:",e),e}},async deleteCollections(e){try{let{error:t}=await i.from("user_collections").delete().in("id",e);if(t)throw console.error("删除收藏失败:",t),t;return!0}catch(e){throw console.error("删除收藏异常:",e),e}},async checkIfCollected(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{let s=i.from("user_collections").select("id").eq("user_id",e).eq("question",t);r&&(s=s.ilike("answer","%".concat(r,"%")));let{data:a,error:o}=await s.limit(1);if(o)throw console.error("检查收藏状态失败:",o),o;return a&&a.length>0}catch(e){throw console.error("检查收藏状态异常:",e),e}}}},9078:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return u}});var s=r(5893),a=r(7294),o=r(9008),n=r.n(o),i=r(1163),l=r(9075),c=r.n(l),d=r(5981);function u(){var e,t;let r=(0,i.useRouter)(),[o,l]=(0,a.useState)(null),[u,_]=(0,a.useState)(!1),[h,m]=(0,a.useState)(!1),[f,p]=(0,a.useState)(""),[v,N]=(0,a.useState)(""),[w,x]=(0,a.useState)(""),[j,b]=(0,a.useState)(""),[g,y]=(0,a.useState)(""),[P,C]=(0,a.useState)(""),[I,S]=(0,a.useState)(!1),[B,k]=(0,a.useState)(!1),[E,F]=(0,a.useState)(!1),[T,q]=(0,a.useState)("");(0,a.useEffect)(()=>{(async()=>{try{let t=await d.r5.getCurrentUser();if(l(t),t){var e;x((null===(e=t.user_metadata)||void 0===e?void 0:e.username)||"")}}catch(e){l(null)}})();let{data:{subscription:e}}=d.r5.onAuthStateChange((e,t)=>{if("SIGNED_IN"===e){if(l((null==t?void 0:t.user)||null),null==t?void 0:t.user){var s;x((null===(s=t.user.user_metadata)||void 0===s?void 0:s.username)||"")}}else"SIGNED_OUT"===e&&(l(null),r.push("/"))});return()=>e.unsubscribe()},[]);let L=async()=>{try{await d.r5.signOut(),_(!1)}catch(e){console.error("登出错误:",e)}},U=(e,t)=>{p(e),N(t),setTimeout(()=>{p(""),N("")},3e3)},A=async e=>{if(e.preventDefault(),!w.trim()){U("用户名不能为空","error");return}m(!0);try{let{data:e,error:t}=await d.r5.supabase.auth.updateUser({data:{username:w.trim()}});if(t)throw t;U("用户名更新成功","success"),S(!1)}catch(e){U(e.message||"用户名更新失败","error")}finally{m(!1)}},D=async e=>{if(e.preventDefault(),!j||!g||!P){U("请填写所有密码字段","error");return}if(g!==P){U("两次输入的新密码不匹配","error");return}if(g.length<6){U("新密码至少需要6个字符","error");return}m(!0);try{let{error:e}=await d.r5.supabase.auth.signInWithPassword({email:o.email,password:j});if(e)throw Error("当前密码不正确");let{error:t}=await d.r5.supabase.auth.updateUser({password:g});if(t)throw t;U("密码更新成功","success"),k(!1),b(""),y(""),C("")}catch(e){U(e.message||"密码更新失败","error")}finally{m(!1)}},G=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),O=async e=>{if(e.preventDefault(),!G(T)){U("请检查邮箱格式","error");return}m(!0),p("");try{let{error:e}=await d.supabase.auth.resetPasswordForEmail(T,{redirectTo:"".concat("https://fanglue.org","/auth?type=recovery")});e?U((0,d.x0)(e),"error"):(U("重置邮件已发送，请检查您的邮箱","success"),F(!1),q(""))}catch(e){U("发送重置邮件失败，请稍后重试","error")}finally{m(!1)}},M=()=>{F(!1),q(""),p("")};return o?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n(),{children:[(0,s.jsx)("title",{children:"个人资料 - 方略 Fanglue"}),(0,s.jsx)("meta",{name:"description",content:"个人资料管理"}),(0,s.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,s.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,s.jsxs)("div",{className:c().container,children:[(0,s.jsxs)("nav",{className:c().navbar,children:[(0,s.jsx)("div",{className:c().brand,onClick:()=>r.push("/"),style:{cursor:"pointer"},children:"方略 Fanglue"}),(0,s.jsx)("div",{className:c().navLinks,children:(0,s.jsxs)("div",{className:c().userMenu,children:[(0,s.jsxs)("button",{className:c().userButton,onClick:()=>_(!u),children:[(null===(e=o.user_metadata)||void 0===e?void 0:e.username)||o.email,(0,s.jsx)("span",{className:c().dropdownArrow,children:"▼"})]}),u&&(0,s.jsxs)("div",{className:c().dropdown,children:[(0,s.jsx)("button",{className:c().dropdownItem,onClick:()=>{_(!1)},children:"个人资料"}),(0,s.jsx)("button",{className:c().dropdownItem,onClick:()=>{_(!1),r.push("/collection")},children:"历问历答"}),(0,s.jsx)("hr",{className:c().dropdownDivider}),(0,s.jsx)("button",{className:c().dropdownItem,onClick:L,children:"退出登录"})]})]})})]}),(0,s.jsx)("main",{className:c().mainContent,children:(0,s.jsxs)("div",{className:c().profileContainer,children:[(0,s.jsx)("h1",{className:c().title,children:"个人资料"}),f&&(0,s.jsx)("div",{className:"".concat(c().message," ").concat(c()[v]),children:f}),(0,s.jsxs)("div",{className:c().section,children:[(0,s.jsx)("h2",{className:c().sectionTitle,children:"用户名"}),I?(0,s.jsxs)("form",{onSubmit:A,className:c().editForm,children:[(0,s.jsx)("input",{type:"text",value:w,onChange:e=>x(e.target.value),placeholder:"请输入用户名",className:c().input,disabled:h}),(0,s.jsxs)("div",{className:c().buttonGroup,children:[(0,s.jsx)("button",{type:"submit",className:c().saveButton,disabled:h,children:h?"保存中...":"保存"}),(0,s.jsx)("button",{type:"button",className:c().cancelButton,onClick:()=>{var e;S(!1),x((null===(e=o.user_metadata)||void 0===e?void 0:e.username)||"")},disabled:h,children:"取消"})]})]}):(0,s.jsxs)("div",{className:c().displayField,children:[(0,s.jsx)("span",{className:c().fieldValue,children:(null===(t=o.user_metadata)||void 0===t?void 0:t.username)||"未设置"}),(0,s.jsx)("button",{className:c().editButton,onClick:()=>S(!0),children:"修改"})]})]}),(0,s.jsxs)("div",{className:c().section,children:[(0,s.jsx)("h2",{className:c().sectionTitle,children:"邮箱"}),(0,s.jsxs)("div",{className:c().displayField,children:[(0,s.jsx)("span",{className:c().fieldValue,children:o.email}),(0,s.jsx)("span",{className:c().fieldNote,children:"邮箱不可修改"})]})]}),(0,s.jsxs)("div",{className:c().section,children:[(0,s.jsx)("h2",{className:c().sectionTitle,children:"密码"}),B?(0,s.jsxs)("form",{onSubmit:D,className:c().editForm,children:[(0,s.jsx)("input",{type:"password",value:j,onChange:e=>b(e.target.value),placeholder:"请输入当前密码",className:c().input,disabled:h}),(0,s.jsx)("input",{type:"password",value:g,onChange:e=>y(e.target.value),placeholder:"请输入新密码",className:c().input,disabled:h}),(0,s.jsx)("input",{type:"password",value:P,onChange:e=>C(e.target.value),placeholder:"请再次输入新密码",className:c().input,disabled:h}),(0,s.jsxs)("div",{className:c().buttonGroup,children:[(0,s.jsx)("button",{type:"submit",className:c().saveButton,disabled:h,children:h?"更新中...":"确认更改"}),(0,s.jsx)("button",{type:"button",className:c().forgotButton,onClick:()=>{q(o.email),F(!0)},disabled:h,children:"忘记密码"}),(0,s.jsx)("button",{type:"button",className:c().cancelButton,onClick:()=>{k(!1),b(""),y(""),C("")},disabled:h,children:"取消修改"})]})]}):(0,s.jsxs)("div",{className:c().displayField,children:[(0,s.jsx)("span",{className:c().fieldValue,children:"••••••••"}),(0,s.jsx)("button",{className:c().editButton,onClick:()=>k(!0),children:"修改"})]})]})]})}),(0,s.jsxs)("footer",{className:c().footerSection,children:[(0,s.jsx)("div",{className:c().footerTitle,children:"让千载经略，为你今日一策"}),(0,s.jsxs)("div",{className:c().footerButtons,children:[(0,s.jsx)("a",{href:"#",className:c().footerBtn,title:"功能开发中，敬请期待",children:"众议百解"}),(0,s.jsx)("a",{href:"#",className:c().footerBtn,title:"功能开发中，敬请期待",children:"一日一策"}),(0,s.jsx)("a",{href:"/collection",className:c().footerBtn,children:"历问历答"})]}),(0,s.jsxs)("div",{className:c().footerNavigation,children:[(0,s.jsx)("span",{className:c().copyright,children:"\xa9 2025 Fanglue.org"}),(0,s.jsx)("span",{className:c().navSeparator,children:"|"}),(0,s.jsx)("a",{href:"/about",className:c().footerNavLink,children:"关于我们"}),(0,s.jsx)("span",{className:c().navSeparator,children:"|"}),(0,s.jsx)("a",{href:"/contact",className:c().footerNavLink,children:"联系我们"}),(0,s.jsx)("span",{className:c().navSeparator,children:"|"}),(0,s.jsx)("a",{href:"/advertise",className:c().footerNavLink,children:"广告合作"}),(0,s.jsx)("span",{className:c().navSeparator,children:"|"}),(0,s.jsx)("a",{href:"/privacy-policy",className:c().footerNavLink,children:"隐私政策"}),(0,s.jsx)("span",{className:c().navSeparator,children:"|"}),(0,s.jsx)("a",{href:"/terms",className:c().footerNavLink,children:"服务条款"})]})]}),E&&(0,s.jsx)("div",{className:c().modal,children:(0,s.jsxs)("div",{className:c().modalContent,children:[(0,s.jsxs)("div",{className:c().modalHeader,children:[(0,s.jsx)("h3",{children:"重置密码"}),(0,s.jsx)("button",{className:c().closeButton,onClick:M,children:"\xd7"})]}),(0,s.jsxs)("form",{onSubmit:O,className:c().forgotPasswordForm,children:[(0,s.jsxs)("div",{className:c().inputGroup,children:[(0,s.jsx)("label",{className:c().label,children:"邮箱地址"}),(0,s.jsx)("input",{type:"email",value:T,onChange:e=>q(e.target.value),className:c().input,placeholder:"请输入您的邮箱地址",required:!0,disabled:h})]}),(0,s.jsxs)("div",{className:c().modalButtons,children:[(0,s.jsx)("button",{type:"button",className:c().cancelButton,onClick:M,disabled:h,children:"取消"}),(0,s.jsx)("button",{type:"submit",className:c().submitButton,disabled:h||!T,children:h?"发送中...":"发送重置邮件"})]})]})]})})]})]}):(0,s.jsx)("div",{className:c().container,children:(0,s.jsx)("div",{className:c().loading,children:"请先登录..."})})}},9075:function(e){e.exports={container:"Profile_container__sLcJd",navbar:"Profile_navbar__9CszE",brand:"Profile_brand__P_4kM",navLinks:"Profile_navLinks__NfxOF",userMenu:"Profile_userMenu___f7ka",userButton:"Profile_userButton__9rq1E",dropdownArrow:"Profile_dropdownArrow__Q2jtr",dropdown:"Profile_dropdown__2bZ8P",dropdownFadeIn:"Profile_dropdownFadeIn__KISKm",dropdownItem:"Profile_dropdownItem__bN3jp",dropdownDivider:"Profile_dropdownDivider__DiseX",mainContent:"Profile_mainContent__8HuB_",profileContainer:"Profile_profileContainer__qyJkg",title:"Profile_title__F61jz",message:"Profile_message__XdqIG",success:"Profile_success__6T7qF",error:"Profile_error__RjMdI",section:"Profile_section__OXw_d",sectionTitle:"Profile_sectionTitle__ILNHD",displayField:"Profile_displayField__FXy5P",fieldValue:"Profile_fieldValue__2vRoX",editButton:"Profile_editButton__d6zpM",fieldNote:"Profile_fieldNote__D0CzE",editForm:"Profile_editForm__Us6pF",input:"Profile_input__dORp6",buttonGroup:"Profile_buttonGroup__HLhR2",saveButton:"Profile_saveButton___s5IK",cancelButton:"Profile_cancelButton__LkvSC",forgotButton:"Profile_forgotButton__yq2am",modal:"Profile_modal__z0rDi",modalContent:"Profile_modalContent__rcc2C",modalFadeIn:"Profile_modalFadeIn__IEfdb",modalHeader:"Profile_modalHeader__ASXTu",closeButton:"Profile_closeButton__QFzoj",forgotPasswordForm:"Profile_forgotPasswordForm__bt_88",inputGroup:"Profile_inputGroup__kvcEP",label:"Profile_label__D4TPG",modalButtons:"Profile_modalButtons__CUmId",submitButton:"Profile_submitButton__exEpL",loading:"Profile_loading__JUtHK",footerSection:"Profile_footerSection__SASEv",footerTitle:"Profile_footerTitle__QBIpl",footerButtons:"Profile_footerButtons__amArm",footerBtn:"Profile_footerBtn__b8qP2",active:"Profile_active__NLVi_",footerNavigation:"Profile_footerNavigation__GaaEK",copyright:"Profile_copyright__mm_AW",navSeparator:"Profile_navSeparator__0e_LM",footerNavLink:"Profile_footerNavLink__bK4NI"}},1163:function(e,t,r){e.exports=r(2937)}},function(e){e.O(0,[608,774,888,179],function(){return e(e.s=9344)}),_N_E=e.O()}]);