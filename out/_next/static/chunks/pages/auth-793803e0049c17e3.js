(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[473],{3969:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/auth",function(){return s(4604)}])},5981:function(e,t,s){"use strict";s.d(t,{G_:function(){return d},YX:function(){return u},r5:function(){return c},supabase:function(){return l},x0:function(){return o}});var a=s(1608),r=s(3454);let n=r.env.SUPABASE_URL||"https://crnfwlpcxrnqfgwqnmun.supabase.co",i=r.env.SUPABASE_ANON_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNybmZ3bHBjeHJucWZnd3FubXVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTAzMDQsImV4cCI6MjA3MDcyNjMwNH0.g_HmFQQiuGW2TZRzZ5gqCj098DZy6iwn_xQAE6kEUEI",l=(0,a.eI)(n,i),o=e=>{let t="";return("string"==typeof e?t=e:(null==e?void 0:e.message)?t=e.message:(null==e?void 0:e.error_description)&&(t=e.error_description),t.toLowerCase().includes("new password should be different"))?"新密码不能与旧密码相同":({"Invalid login credentials":"邮箱或密码错误","Email not confirmed":"邮箱未验证，请检查您的邮箱","User already registered":"该邮箱已注册","Password should be at least 6 characters":"密码至少需要6位字符","Signup requires a valid password":"注册需要有效的密码","Invalid email":"邮箱格式不正确","Email rate limit exceeded":"邮件发送频率过高，请稍后再试","Too many requests":"请求过于频繁，请稍后再试","Network request failed":"网络请求失败，请检查网络连接","User not found":"用户不存在","Email already taken":"该邮箱已被使用","Weak password":"密码强度不够，请使用更复杂的密码","New password should be different from the old password":"新密码不能与旧密码相同","new password should be different from the old password":"新密码不能与旧密码相同","Password update failed":"密码更新失败，请稍后重试","Session not found":"会话已过期，请重新获取重置链接","Invalid recovery token":"重置链接无效或已过期，请重新申请","Auth session missing":"认证会话缺失，请重新获取重置链接"})[t]||t||"发生未知错误，请稍后重试"},c={async signUp(e,t,s){try{let{data:a,error:r}=await l.auth.signUp({email:e,password:t,options:{data:{username:s},emailRedirectTo:"".concat("https://fanglue.org","/auth")}});if(r)throw Error(o(r));return a}catch(e){throw Error(o(e))}},async signIn(e,t){try{let{data:s,error:a}=await l.auth.signInWithPassword({email:e,password:t});if(a)throw Error(o(a));return s}catch(e){throw Error(o(e))}},async signOut(){try{let{error:e}=await l.auth.signOut();if(e)throw Error(o(e));return!0}catch(e){throw Error(o(e))}},async getCurrentUser(){try{let{data:{user:e},error:t}=await l.auth.getUser();if(t)throw Error(o(t));return e}catch(e){throw Error(o(e))}},onAuthStateChange:e=>l.auth.onAuthStateChange(e)},u={supabase:l,async insert(e,t){let{data:s,error:a}=await l.from(e).insert(t).select();if(a)throw console.error("插入数据错误:",a),a;return s},async select(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=l.from(e).select("*");Object.entries(t).forEach(e=>{let[t,a]=e;s=s.eq(t,a)});let{data:a,error:r}=await s;if(r)throw console.error("查询数据错误:",r),r;return a},async update(e,t,s){let{data:a,error:r}=await l.from(e).update(s).eq("id",t).select();if(r)throw console.error("更新数据错误:",r),r;return a},async delete(e,t){let{error:s}=await l.from(e).delete().eq("id",t);if(s)throw console.error("删除数据错误:",s),s;return!0},async testConnection(){try{let{data:e,error:t}=await l.rpc("version");if(t){let{error:e}=await l.from("test_connection_table").select("*").limit(1);if(e&&("PGRST116"===e.code||"42P01"===e.code))return console.log("数据库连接成功!"),!0;return console.error("数据库连接测试失败:",e||t),!1}return console.log("数据库连接成功!"),!0}catch(e){return console.error("连接测试异常:",e),!1}}},d={async saveCollection(e,t,s){try{let{data:a,error:r}=await l.from("user_collections").insert({user_id:e,question:t,answer:s}).select();if(r)throw console.error("收藏保存失败:",r),r;return a[0]}catch(e){throw console.error("收藏操作异常:",e),e}},async getUserCollections(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;try{let a=(t-1)*s,{data:r,error:n,count:i}=await l.from("user_collections").select("*",{count:"exact"}).eq("user_id",e).order("updated_at",{ascending:!1}).range(a,a+s-1);if(n)throw console.error("获取收藏列表失败:",n),n;return{data:r||[],total:i||0,page:t,pageSize:s,totalPages:Math.ceil((i||0)/s)}}catch(e){throw console.error("获取收藏列表异常:",e),e}},async deleteCollections(e){try{let{error:t}=await l.from("user_collections").delete().in("id",e);if(t)throw console.error("删除收藏失败:",t),t;return!0}catch(e){throw console.error("删除收藏异常:",e),e}},async checkIfCollected(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{let a=l.from("user_collections").select("id").eq("user_id",e).eq("question",t);s&&(a=a.ilike("answer","%".concat(s,"%")));let{data:r,error:n}=await a.limit(1);if(n)throw console.error("检查收藏状态失败:",n),n;return r&&r.length>0}catch(e){throw console.error("检查收藏状态异常:",e),e}}}},4604:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return h}});var a=s(5893),r=s(7294),n=s(1163),i=s(9008),l=s.n(i),o=s(3323),c=s.n(o),u=s(5981);let d=e=>{let{showForgotPassword:t,resetEmail:s,isLoading:r,onClose:n,onSubmit:i,onEmailChange:l}=e;return t?(0,a.jsx)("div",{className:c().modal,children:(0,a.jsxs)("div",{className:c().modalContent,children:[(0,a.jsxs)("div",{className:c().modalHeader,children:[(0,a.jsx)("h3",{children:"重置密码"}),(0,a.jsx)("button",{className:c().closeButton,onClick:n,children:"\xd7"})]}),(0,a.jsxs)("form",{onSubmit:i,className:c().forgotPasswordForm,children:[(0,a.jsxs)("div",{className:c().inputGroup,children:[(0,a.jsx)("label",{className:c().label,children:"邮箱地址"}),(0,a.jsx)("input",{type:"email",value:s,onChange:l,className:c().input,placeholder:"请输入您的邮箱地址",required:!0,disabled:r})]}),(0,a.jsxs)("div",{className:c().modalButtons,children:[(0,a.jsx)("button",{type:"button",className:c().cancelButton,onClick:n,disabled:r,children:"取消"}),(0,a.jsx)("button",{type:"submit",className:c().submitButton,disabled:r||!s,children:r?"发送中...":"发送重置邮件"})]})]})]})}):null};function h(){let e=(0,n.useRouter)(),[t,s]=(0,r.useState)(!0),[i,o]=(0,r.useState)(!1),[h,m]=(0,r.useState)(""),[_,p]=(0,r.useState)(""),[f,x]=(0,r.useState)(""),[b,g]=(0,r.useState)(""),[v,j]=(0,r.useState)(""),[w,N]=(0,r.useState)(""),[y,A]=(0,r.useState)(!1),[C,S]=(0,r.useState)(""),[q,I]=(0,r.useState)(!1),[k,E]=(0,r.useState)("");(0,r.useEffect)(()=>{let{data:{subscription:t}}=u.supabase.auth.onAuthStateChange((t,s)=>{if(console.log("Auth state change:",t,s),"SIGNED_IN"===t){let{type:t}=e.query;if("recovery"===t){o(!0),S("");return}if("signup"===t){S("邮箱验证成功！欢迎使用！"),e.push("/");return}i||e.push("/")}"PASSWORD_RECOVERY"===t&&(o(!0),S("")),"SIGNED_OUT"===t&&(o(!1),S(""))}),{type:s}=e.query;return"recovery"===s?o(!0):o(!1),()=>t.unsubscribe()},[e.query,i]);let B=()=>{if(!T(h))return S("请检查邮箱格式"),!1;if(t){if(f.length<8)return S("密码至少需要8位字符"),!1}else{if(_.length<3)return S("用户名至少需要3个字符"),!1;if(!U(f).isValid)return S("请输入正确格式的密码"),!1;if(f!==b)return S("两次输入的密码不一致"),!1}return!0},P=async e=>{if(e.preventDefault(),B()){A(!0),S("");try{let{data:e,error:t}=await u.supabase.auth.signUp({email:h,password:f,options:{data:{username:_},emailRedirectTo:"".concat("https://fanglue.org","/auth?type=signup")}});t?(console.error("注册错误:",t),S((0,u.x0)(t))):S("注册成功！请检查您的邮箱以验证账户。")}catch(e){console.error("注册异常:",e),S((0,u.x0)(e)||"注册失败，请稍后重试")}finally{A(!1)}}},F=async e=>{e.preventDefault(),A(!0),S("");try{let{data:e,error:t}=await u.supabase.auth.signInWithPassword({email:h,password:f});t&&(console.error("登录错误:",t),S((0,u.x0)(t)))}catch(e){console.error("登录异常:",e),S((0,u.x0)(e)||"登录失败，请稍后重试")}finally{A(!1)}},T=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),U=e=>{let t=/\d/.test(e),s=/[a-zA-Z]/.test(e),a=/[!@#$%^&*(),.?":{}|<>]/.test(e),r=e.length>=8;return{hasNumber:t,hasLetter:s,hasSpecial:a,hasMinLength:r,isValid:t&&s&&a&&r}},G=async e=>{if(e.preventDefault(),!T(k)){S("请检查邮箱格式");return}A(!0),S("");try{let{error:e}=await u.supabase.auth.resetPasswordForEmail(k,{redirectTo:"".concat("https://fanglue.org","/auth?type=recovery")});e?S((0,u.x0)(e.message)):(S("重置邮件已发送，请检查您的邮箱"),I(!1),E(""))}catch(e){S("发送重置邮件失败，请稍后重试")}finally{A(!1)}},O=async t=>{if(t.preventDefault(),!U(v).isValid){S("请输入正确格式的密码");return}if(v!==w){S("两次输入的密码不一致");return}A(!0),S("");try{let{data:{session:t},error:s}=await u.supabase.auth.getSession();if(s||!t){S("重置会话已过期，请重新获取重置链接"),A(!1);return}let{error:a}=await u.supabase.auth.updateUser({password:v});a?(console.error("密码更新错误:",a),S((0,u.x0)(a))):(S("密码更新成功！正在跳转到登录页面..."),setTimeout(async()=>{await u.supabase.auth.signOut(),o(!1),j(""),N(""),S(""),e.replace("/auth")},2e3))}catch(e){console.error("密码更新错误:",e),S((0,u.x0)(e)||"密码更新失败，请稍后重试")}finally{A(!1)}};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(l(),{children:[(0,a.jsxs)("title",{children:[i?"重置密码":t?"登录":"注册"," - 方略 Fanglue"]}),(0,a.jsx)("meta",{name:"description",content:"方略 - 从经史到兵法，古智与算法，同答一问"}),(0,a.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,a.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,a.jsxs)("div",{className:c().container,children:[(0,a.jsx)("nav",{className:c().navbar,children:(0,a.jsx)("div",{className:c().brand,onClick:()=>e.push("/"),style:{cursor:"pointer"},children:"方略 Fanglue"})}),(0,a.jsxs)("main",{className:c().mainContent,children:[(0,a.jsx)("div",{className:c().authCard,children:i?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:c().authTabs,children:(0,a.jsx)("div",{className:"".concat(c().tabButton," ").concat(c().active),children:"重置密码"})}),(0,a.jsxs)("form",{onSubmit:O,className:c().authForm,children:[(0,a.jsxs)("div",{className:c().inputGroup,children:[(0,a.jsxs)("label",{className:c().label,children:["新密码",(0,a.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,a.jsx)("input",{type:"password",value:v,onChange:e=>j(e.target.value),className:c().input,placeholder:"请输入至少8位字符，包含字母、数字和特殊符号",disabled:y,required:!0}),v&&(0,a.jsx)("div",{className:c().hint,children:!U(v).isValid&&(0,a.jsx)("span",{className:c().invalid,children:"请输入正确格式的密码"})})]}),(0,a.jsxs)("div",{className:c().inputGroup,children:[(0,a.jsxs)("label",{className:c().label,children:["确认新密码",(0,a.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,a.jsx)("input",{type:"password",value:w,onChange:e=>N(e.target.value),className:c().input,placeholder:"请输入至少8位字符，包含字母、数字和特殊符号",disabled:y,required:!0}),w&&(0,a.jsx)("div",{className:c().hint,children:(0,a.jsx)("span",{className:v===w?c().valid:c().invalid,children:v===w?"✓ 密码一致":"✗ 密码不一致"})})]}),(0,a.jsx)("button",{type:"submit",className:c().submitButton,disabled:y||!v||!w||v!==w,children:y?"更新中...":"更新密码"}),C&&(0,a.jsx)("div",{className:"".concat(c().message," ").concat(C.includes("成功")?c().success:c().error),children:C})]})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:c().authTabs,children:[(0,a.jsx)("button",{className:"".concat(c().tabButton," ").concat(t?c().active:""),onClick:()=>{s(!0),S("")},children:"登录"}),(0,a.jsx)("button",{className:"".concat(c().tabButton," ").concat(t?"":c().active),onClick:()=>{s(!1),S("")},children:"注册"})]}),(0,a.jsxs)("form",{onSubmit:t?F:P,className:c().authForm,children:[(0,a.jsxs)("div",{className:c().inputGroup,children:[(0,a.jsxs)("label",{className:c().label,children:["邮箱",(0,a.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,a.jsx)("input",{type:"email",value:h,onChange:e=>{m(e.target.value),S("")},className:c().input,placeholder:"请输入您的邮箱地址",disabled:y,required:!0}),h&&!T(h)&&(0,a.jsx)("div",{className:c().hint,children:(0,a.jsx)("span",{className:c().invalid,children:"请检查邮箱格式"})})]}),!t&&(0,a.jsxs)("div",{className:c().inputGroup,children:[(0,a.jsxs)("label",{className:c().label,children:["用户名",(0,a.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,a.jsx)("input",{type:"text",value:_,onChange:e=>{p(e.target.value),S("")},className:c().input,placeholder:"至少3个字符",disabled:y,required:!0}),_&&_.length<3&&(0,a.jsx)("div",{className:c().hint,children:(0,a.jsx)("span",{className:c().invalid,children:"用户名至少需要3个字符"})})]}),(0,a.jsxs)("div",{className:c().inputGroup,children:[(0,a.jsxs)("label",{className:c().label,children:["密码",(0,a.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,a.jsx)("input",{type:"password",value:f,onChange:e=>{x(e.target.value),S("")},className:c().input,placeholder:t?"请输入您的密码":"8位以上，必须包含数字、字母和特殊符号",disabled:y,required:!0}),!t&&f&&!U(f).isValid&&(0,a.jsx)("div",{className:c().hint,children:(0,a.jsx)("span",{className:c().invalid,children:"请输入正确格式的密码"})})]}),!t&&(0,a.jsxs)("div",{className:c().inputGroup,children:[(0,a.jsxs)("label",{className:c().label,children:["确认密码",(0,a.jsx)("span",{className:c().requiredAsterisk,children:" *"})]}),(0,a.jsx)("input",{type:"password",value:b,onChange:e=>{g(e.target.value),S("")},className:c().input,placeholder:"8位以上，必须包含数字、字母和特殊符号",disabled:y,required:!0}),b&&(0,a.jsx)("div",{className:c().hint,children:(0,a.jsx)("span",{className:f===b?c().valid:c().invalid,children:f===b?"✓ 密码一致":"两次输入的密码不一致"})})]}),(0,a.jsx)("button",{type:"submit",className:c().submitButton,disabled:y||(t?!h||!f||!T(h):!h||!_||!f||!b||!T(h)||_.length<3||!U(f).isValid||f!==b),children:y?t?"登录中...":"注册中...":t?"登录":"注册"}),t&&(0,a.jsx)("div",{className:c().forgotPasswordLink,children:(0,a.jsx)("button",{type:"button",onClick:()=>I(!0),className:c().linkButton,disabled:y,children:"忘记密码？"})}),C&&(0,a.jsx)("div",{className:"".concat(c().message," ").concat(C.includes("成功")?c().success:c().error),children:C})]})]})}),(0,a.jsx)(d,{showForgotPassword:q,resetEmail:k,isLoading:y,onClose:()=>{I(!1),E(""),S("")},onSubmit:G,onEmailChange:e=>{E(e.target.value),S("")}})]})]})]})}},3323:function(e){e.exports={container:"Auth_container__0j_dd",navbar:"Auth_navbar__yb_gp",brand:"Auth_brand__VpLSG",mainContent:"Auth_mainContent__MOMp6",authCard:"Auth_authCard__c52sr",slideUp:"Auth_slideUp__qeMUA",authTabs:"Auth_authTabs__5_7HH",tabButton:"Auth_tabButton__hh0se",active:"Auth_active__HnjZM",authForm:"Auth_authForm__Q3DLf",inputGroup:"Auth_inputGroup__O2PQ9",label:"Auth_label__si14T",requiredAsterisk:"Auth_requiredAsterisk___2jh_",input:"Auth_input___yjIt",error:"Auth_error__npNR5",hint:"Auth_hint__Mc8tH",errorText:"Auth_errorText__FtdKD",valid:"Auth_valid__dI1Xr",invalid:"Auth_invalid__i8q04",passwordStrength:"Auth_passwordStrength__j_3TF",strengthItem:"Auth_strengthItem__j8RZr",submitButton:"Auth_submitButton__Pzzy8",message:"Auth_message__Xz_Ou",success:"Auth_success__qQE_4",forgotPasswordLink:"Auth_forgotPasswordLink__DSh_y",linkButton:"Auth_linkButton__jGVVS",modal:"Auth_modal__vM8A3",fadeIn:"Auth_fadeIn__kLcDR",modalContent:"Auth_modalContent__pI81o",modalHeader:"Auth_modalHeader__UDiYd",closeButton:"Auth_closeButton__VxqO2",forgotPasswordForm:"Auth_forgotPasswordForm__GgQWm",modalButtons:"Auth_modalButtons__MOGII",cancelButton:"Auth_cancelButton__DEpf5"}},9008:function(e,t,s){e.exports=s(4764)},1163:function(e,t,s){e.exports=s(2937)}},function(e){e.O(0,[608,774,888,179],function(){return e(e.s=3969)}),_N_E=e.O()}]);