"use strict";(()=>{var e={};e.id=155,e.ids=[155],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},9935:(e,t,r)=>{r.r(t),r.d(t,{config:()=>y,default:()=>b,routeModule:()=>_});var n={};r.r(n),r.d(n,{default:()=>p});var o=r(1802),a=r(7153),l=r(6249);let c=require("@supabase/supabase-js"),s=process.env.SUPABASE_URL||"https://crnfwlpcxrnqfgwqnmun.supabase.co",i=process.env.SUPABASE_ANON_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNybmZ3bHBjeHJucWZnd3FubXVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTAzMDQsImV4cCI6MjA3MDcyNjMwNH0.g_HmFQQiuGW2TZRzZ5gqCj098DZy6iwn_xQAE6kEUEI",u=(0,c.createClient)(s,i);async function p(e,t){if("POST"!==e.method)return t.status(405).json({error:"仅支持POST请求"});try{let{question:r,strategy_category:n}=e.body;if(!r||!n)return t.status(400).json({error:"缺少必要参数：question 和 strategy_category"});console.log("收到搜索请求:",{question:r,strategy_category:n});let o=await f(n);if(!o)return t.status(404).json({error:"未找到对应策略的书籍"});console.log("选中的书籍:",o.book_name);let a=await g(o.book_name,r);if(!a)return t.status(500).json({error:"未能找到相关原文",quote:"智者顺时而谋，愚者逆势而动。",bookName:o.book_name,chapterName:"经典智慧",source:`${o.book_name}\xb7经典智慧`,fromNetworkSearch:!1});console.log("找到的原文:",a);let l=await m(o.book_name,a);return console.log("识别的章节名:",l),t.status(200).json({quote:a,bookName:o.book_name,chapterName:l||"未知章节",source:`${o.book_name}\xb7${l||"未知章节"}`,searchQuery:r,fromNetworkSearch:!0,strategy_category:n})}catch(e){return console.error("搜索引用失败:",e),t.status(500).json({error:"搜索服务暂时不可用",quote:"智者顺时而谋，愚者逆势而动。",bookName:"智慧经典",chapterName:"第一章",source:"智慧经典\xb7第一章",fromNetworkSearch:!1})}}async function f(e){try{let{data:t,error:r}=await u.from("book_library").select("*").eq("strategy_category",e);if(r)return console.error("查询书籍失败:",r),null;if(!t||0===t.length)return console.log("未找到对应策略的书籍:",e),null;let n=Math.floor(Math.random()*t.length);return t[n]}catch(e){return console.error("选择书籍时出错:",e),null}}async function g(e,t){try{let r=`请从《${e}》中找出能够回答"${t}"这个问题的1-3句经典原文，要求：1. 必须是该书的原文内容；2. 内容要与问题高度相关；3. 返回格式为纯文本，不要解释`;console.log("AI搜索原文查询:",r);let n=await fetch("https://api.deepseek.com/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer sk-3dd5328db9d44d9cb4e6e7df02ee4b2d"},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"user",content:r}],temperature:.7,max_tokens:2e3,stream:!1})});if(!n.ok)return console.log("DeepSeek API调用失败，尝试备用方案"),await h(e,t);let o=await n.json();if(o.choices&&o.choices.length>0&&o.choices[0].message.content&&o.choices[0].message.content.length>10){let t=o.choices[0].message.content,r=function(e,t){if(!e)return null;let r=e.replace(/<[^>]*>/g,"").trim();if(r=(r=(r=(r=r.replace(/^\d+\.\s*/gm,"")).replace(/\([^)]*\)/g,"").replace(/（[^）]*）/g,"")).replace(/此句[^。]*。?/g,"").replace(/这句话[^。]*。?/g,"")).replace(/出自[^。]*。?/g,"").replace(/来源[^。]*。?/g,""),t){let e=RegExp(`《?${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}》?[\xb7s]*`,"gi");r=r.replace(e,"")}let n=(r=(r=(r=(r=(r=(r=(r=(r=(r=r.replace(/.*?》："/g,"")).replace(/.*?】："/g,"")).replace(/.*?〉："/g,"")).replace(/.*?》：/g,"")).replace(/.*?】：/g,"")).replace(/.*?〉：/g,"")).replace(/^[^：]*：/gm,"")).replace(/^"/g,"").replace(/"$/g,"")).replace(/^'/g,"").replace(/'$/g,"")).split(/[。！？；]/).filter(e=>e.length>5&&e.length<50);for(let e of n){let t=e.trim();if(function(e){return[/[之乎者也矣焉]/,/[君子小人]/,/[天下国家]/,/[道德仁义]/,/[智勇仁]/].some(t=>t.test(e))}(t)&&!t.includes("《")&&!t.includes("篇"))return t}for(let e of n){let t=e.trim();if(t.length>=10&&t.length<=30&&!t.includes("《"))return t}return n.length>0?n[0].trim():null}(t,e);if(r&&r.length>10)return r}return await h(e,t)}catch(r){return console.error("AI搜索原文失败:",r),await h(e,t)}}async function h(e,t){try{let{data:r,error:n}=await u.from("book_library").select("*").eq("book_name",e).limit(1);if(n||!r||0===r.length)return null;let o=r[0];if(!o.chapter_content)return null;let a=function(e,t){if(!e)return[];let r=e.split(/[。！？；]/).filter(e=>e.length>5),n=function(e){let t=["如何","怎么","什么","为什么","哪个","哪些","应该","可以","能够","的","了","吗","呢","吧"];return e.split(/[\s，。！？；]+/).filter(e=>e.length>=2&&!t.includes(e))}(t),o=r.filter(e=>n.some(t=>e.includes(t))).slice(0,3);return o.length>0?o:r.slice(0,2)}(o.chapter_content,t);if(a.length>0)return a.slice(0,3).join("，");return null}catch(e){return console.error("备用搜索失败:",e),null}}async function m(e,t){try{let r=`这段原文"${t}"出自《${e}》的哪个章节？请只返回章节名称，不要其他解释`;console.log("AI搜索章节名查询:",r);let n=await fetch("https://api.deepseek.com/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer sk-3dd5328db9d44d9cb4e6e7df02ee4b2d"},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"user",content:r}],temperature:.7,max_tokens:2e3,stream:!1})});if(!n.ok)return await d(e,t);let o=await n.json();if(o.choices&&o.choices.length>0&&o.choices[0].message.content){let e=function(e){if(!e)return null;let t=e.replace(/<[^>]*>/g,"").trim();for(let e of[/第[一二三四五六七八九十\d]+章[：:]?([^，。！？；]+)/,/第[一二三四五六七八九十\d]+篇[：:]?([^，。！？；]+)/,/([^，。！？；]{2,10})[章篇]/,/《[^》]+》([^，。！？；]{2,15})/]){let r=t.match(e);if(r)return r[1]?r[1].trim():r[0].trim()}let r=t.split(/[，。！？；\s]+/).filter(e=>e.length>=2&&e.length<=8);return r.length>0?r[0]:null}(o.choices[0].message.content);if(e)return e}return await d(e,t)}catch(r){return console.error("AI搜索章节名失败:",r),await d(e,t)}}async function d(e,t){try{let{data:r,error:n}=await u.from("book_library").select("*").eq("book_name",e);if(n||!r||0===r.length)return"经典篇章";for(let e of r)if(e.chapter_content&&e.chapter_content.includes(t.substring(0,10)))return e.chapter_name||"经典篇章";return r[0].chapter_name||"经典篇章"}catch(e){return console.error("备用章节名搜索失败:",e),"经典篇章"}}let b=(0,l.l)(n,"default"),y=(0,l.l)(n,"config"),_=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/search-quotes",pathname:"/api/search-quotes",bundlePath:"",filename:""},userland:n})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=9935);module.exports=r})();